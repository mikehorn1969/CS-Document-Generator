<!DOCTYPE html>

{% extends "base.html" %}

{% block head %}
    {{ super() }}    
{% endblock %}

{% block content %}

    <h1>Document Generator</h1>

    <div class="indexgrid"> 
        <div> <!-- column 1 - search combo -->
            <!-- Service ID -->
            
            <label for="sid" class="index-label"><strong>Service Provider</strong></label>
            <div>
                <input type="text" id="sid" placeholder="Begin typing a surname..." autocomplete="off" class="name-textbox"
                    value="{{ session['candidateName'] if session and session.get('candidateName') else '' }}">
                <div id="suggestions"></div>
            </div>
            <div>                
                <input type='hidden' name='candidateId' id="candidateId" >
            </div>            
        </div>
        
        <div> <!-- column 2 - data views -->
            <div>
                <form action="colleaguedata" method="get">
                    <input type="submit" value="Colleague Data" id="submit-btn" class="button"/>     
                </form>
            </div>
            
            <div>
                <form action="servicestandards" method="get">
                    <div>
                        <input type="submit" name="which" value="CS Standards" id="ssn-btn" class="button"/>
                    </div>
                    <div>
                        <input type="submit" name="which" value="SP Standards" id="sp-btn" class="button"/>
                    </div>
                </form>
            </div>

            <div>
                <form action="servicearrangements" method="get">                
                    <input type="submit" value="Service Arrangements" id="arr-btn" class="button"/>                    
                </form>        
            </div>
            <div>
                <form action="clearsession" method="post">              
                    <input type="submit" value="Clear Session" id="reset-btn" class="reset-button"/>                                
                </form>
            </div>
        </div>
        <div> <!-- column 3 - documents -->
            <div>       
                <form action="spnda" method="get">
                    <input type="submit" value="Service Provider NDA" id="spnda-btn" class="button"/>                        
                </form>
            </div>             
            <div>  
                <form action="spmsa" method="get">
                    <input type="submit" value="Service Provider MSA" id="spmsa-btn" class="button"/>
                </form>
            </div>   
            <div>       
                <form action="spcontract" method="get">
                    <input type="submit" value="Service Provider Contract" id="spcontract-btn" class="button"/>                        
                </form>
            </div>  
            <div>  
                <form action="clientmsa" method="get">
                    <input type="submit" value="Client MSA" id="clientmsa-btn" class="button"/>
                </form>
            </div>   
            <div>       
                <form action="clientcontract" method="get">
                    <input type="submit" value="Client Contract" id="clientcontract-btn" class="button"/>                        
                </form>
            </div>                                  
        </div>    
    </div>

<script>
    (() => {
        const TRACK = [/\/searchcandidates\b/i, /\/contract\/candidate\b/i];
        const LOADING_CLASS = 'loading';
        let pending = 0;

        // Safely get a URL string and pathname for matching
        function getUrlInfo(input) {
            const u = typeof input === 'string' ? input : (input && input.url) || '';
            const url = new URL(u, window.location.href);
            return { full: url.href, path: url.pathname };
        }

        function matchesTracked(input) {
            const { path, full } = getUrlInfo(input);
            return TRACK.some(re => re.test(path) || re.test(full));
        }

        function inc() {
            if (++pending === 1) document.body.classList.add(LOADING_CLASS);
        }
        function dec() {
            if (pending > 0 && --pending === 0) document.body.classList.remove(LOADING_CLASS);
        }

        // Ensure body exists before we start toggling
        if (!document.body) {
            document.addEventListener('DOMContentLoaded', () => {}); // just to ensure body is ready
        }

        // --- fetch ---
        if (window.fetch) {
            const _fetch = window.fetch.bind(window);
            window.fetch = function(input, init) {
            const track = matchesTracked(input);
            if (track) inc();
            return _fetch(input, init)
                .catch(err => { if (track) dec(); throw err; })
                .then(res => { if (track) dec(); return res; });
            };
        }

        // --- XMLHttpRequest (covers jQuery, plain XHR) ---
        (function() {
            const _open = XMLHttpRequest.prototype.open;
            const _send = XMLHttpRequest.prototype.send;

            XMLHttpRequest.prototype.open = function(method, url, ...rest) {
            this.__track_loading = matchesTracked(url);
            return _open.call(this, method, url, ...rest);
            };

            XMLHttpRequest.prototype.send = function(...args) {
            if (this.__track_loading) {
                inc();
                const done = () => { dec(); cleanup(); };
                const cleanup = () => {
                this.removeEventListener('load', done);
                this.removeEventListener('error', done);
                this.removeEventListener('abort', done);
                };
                this.addEventListener('load', done);
                this.addEventListener('error', done);
                this.addEventListener('abort', done);
            }
            return _send.apply(this, args);
            };
        })();

        // Show wait cursor on page navigations (forms/links)  
        window.addEventListener('beforeunload', () => {
            document.body.classList.add(LOADING_CLASS);
        });
    })();

    $(document).ready(function() {
        $("#sid").on("input", function() {
            let query = $(this).val();
            if (query.length > 3) {

                $.getJSON("/searchcandidates", { q: query }, function(data) {

                    const $sugs = $("#suggestions").empty();
                    data.forEach(function (item) {
                        const $row = $('<div class="candidate-suggestion"></div>')
                        .text(item.candidateName)
                        .data({
                            candidateId: item.candidateId || "",
                            candidateEmail: item.candidateEmail || "",
                            candidatePhone: item.candidatePhone || "",
                            candidateLtdName: item.candidateLtdName || "",
                            candidateLtdRegNo: item.candidateLtdRegNo || "",
                            candidateJurisdiction: item.candidateJurisdiction || "",
                            candidateAddress: item.candidateAddress || "",
                            candidateName: item.candidateName || ""
                        });
                        $sugs.append($row);
                    }); 
                });
                
            } else {
                $("#suggestions").empty();
            }
        });

        $("#suggestions").on("click", ".candidate-suggestion", function () {
            
            const $s = $(this);
            $("#sid").val($s.text());
            $("#candidateId").val($s.data("candidateId"));     
            
            const payload = { candidateId: $s.data("candidateId") };
            $("#suggestions").empty();

            $.ajax({
                url: "/contract/candidate",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify(payload)
            }).fail(xhr => console.error("Save failed:", xhr.responseText));

        });

    });
</script>

{% endblock %}