<!DOCTYPE html>

{% extends "base.html" %}
{% block title %}CS Document Generator v0.3{% endblock %}
{% block head %}
    {{ super() }}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

{% endblock %}

{% block content %}

    <h1>Document Generator</h1>

    <div class="c7grid"> 
        <div> <!-- column 1 - search combo -->
            <!-- Service ID -->
            
            <label for="sid" class="index-label"><strong>Service Provider</strong></label>
            <div>
                <input type="text" id="sid" placeholder="Type a candidate surname..." autocomplete="off" class="name-textbox"
                    value="{{ session['candidateName'] if session and session.get('candidateName') else '' }}">
                <div id="suggestions"></div>
            </div>
            <div>                
                <input type='hidden' name='candidateId' id="candidateId" >
            </div>            
        </div>
        
        <div> <!-- column 2 - data views -->
            <div>
                <form action="colleaguedata" method="get">
                    {% if session['sessionContract'] %}
                        <input type="submit" value="Colleague Data" id="add-btn" class="button"/>
                    {% else %}
                        <input type="submit" value="Colleague Data" id="submit-btn" class="button"/>
                    {% endif %}        
                </form>
            </div>
            <div>
                <form action="servicestandards" method="get">
                    {% if session['serviceStandards'] %}
                        <input type="submit" value="Service Standards" id="add-btn" class="button"/>
                    {% else %}
                        <input type="submit" value="Service Standards" id="submit-btn" class="button"/>
                    {% endif %}
                </form>
            </div>
            <div>
                <form action="servicearrangements" method="get">                
                    <input type="submit" value="Service Arrangements" id="submit-btn" class="button"/>                    
                </form>        
            </div>
            <div>
                <form action="clearsession" method="post">              
                    <input type="submit" value="Clear Session" id="reset-btn" class="reset-button"/>                                
                </form>
            </div>
        </div>
        <div> <!-- column 3 - documents -->
            <div>  
                <form action="clientmsa" method="get">
                    <input type="submit" value="Client MSA" id="submit-btn" class="button"/>
                </form>
            </div>              
            <div>  
                <form action="spmsa" method="get">
                    <input type="submit" value="Candidate MSA" id="submit-btn" class="button"/>
                </form>
            </div>    
            <div>       
                <form action="clientcontract" method="get">
                    <input type="submit" value="Client Contract" id="submit-btn" class="button"/>                        
                </form>
            </div>            
            <div>       
                <form action="spcontract" method="get">
                    <input type="submit" value="Service Provider Contract" id="submit-btn" class="button"/>                        
                </form>
            </div>            
            <div>       
                <form action="candidatenda" method="get">
                    <input type="submit" value="Candidate NDA" id="submit-btn" class="button"/>                        
                </form>
            </div>            
        </div>    
    </div>

{% with messages = get_flashed_messages(category_filter=['error']) %}
    {% if messages %}
        <script>
            window.addEventListener('DOMContentLoaded', () => {
                alert( {{ messages[0] | tojson }} );
            });
        </script>        
    {% endif %}
{% endwith %}                        

<script>
    $(document).ready(function() {
        $("#sid").on("input", function() {
            let query = $(this).val();
            if (query.length > 3) {
                $.getJSON("/searchcandidates", { q: query }, function(data) {
                    const $sugs = $("#suggestions").empty();
                    data.forEach(function (item) {
                        const $row = $('<div class="candidate-suggestion"></div>')
                        .text(item.candidateName)
                        .data({
                            candidateId: item.candidateId || "",
                            candidateEmail: item.candidateEmail || "",
                            candidatePhone: item.candidatePhone || "",
                            candidateLtdName: item.candidateLtdName || "",
                            candidateLtdRegNo: item.candidateLtdRegNo || "",
                            candidateJurisdiction: item.candidateJurisdiction || "",
                            candidateAddress: item.candidateAddress || "",
                            candidateName: item.candidateName || ""
                        });
                        $sugs.append($row);
                    });                   
                    
                });
            } else {
                $("#suggestions").empty();
            }
        });

        $("#suggestions").on("click", ".candidate-suggestion", function () {
            const $s = $(this);
            $("#sid").val($s.text());
            $("#candidateId").val($s.data("candidateId"));     
            
            console.log("Selected candidateId:", $s.data("candidateId"));
            const payload = { candidateId: $s.data("candidateId") };
            $("#suggestions").empty();

            $.ajax({
                url: "/contract/candidate",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify(payload)
            }).fail(xhr => console.error("Save failed:", xhr.responseText));

        });

    });
</script>

{% endblock %}