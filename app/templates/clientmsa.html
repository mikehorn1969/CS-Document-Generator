{% extends "base.html" %}
{% block title %}CS MSA Generator{% endblock %}
{% block head %}
    {{ super() }}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
{% endblock %}

{% block content %}

<h1>Client MSA</h1>


<form action="/download_client_msa" method="post">
    <div class="clientgrid">
        <div>
            <div>
                <label for="AgreementDate" class="index-label"><strong>Agreement Date</strong></label>    
                <div>        
                    <input type="date" name="AgreementDate" placeholder="Agreement Date" value="{{ contract['AgreementDate'] if contract and contract.get('AgreementDate') else '' }}">
                </div>
            </div>
            <div>
                <label for="clientname" class="index-label"><strong>Client</strong></label>
                <div>
                    <input type="text" id="clientname" name="clientname" placeholder="Type a client name..." autocomplete="off" class="name-textbox" value="{{ contract['companyname'] if contract and contract.get('companyname') else '' }}">
                        <div id="suggestions"></div>
                </div>
            </div>
            <div>
                <input type="submit" name="btSumbit" class="button" id="submit-btn" value="Submit">
                <a href="{{ url_for('index') }}" class="button">Back</a>
            </div>
        </div>
        <div>
            <div>
                <label for="RegNumber" class="index-label"><strong>Company Registration Number</strong></label>    
                <div>
                    <input type="text" id="RegNumber" name="RegNumber" placeholder="Company Number" value="{{ contract['companyregistrationnumber'] if contract and contract.get('companyregistrationnumber') else '' }}">
                    <input type="submit" name="btFetch" class="small-button" id="fetch-btn" value="Fetch" formaction="/chfetch">                    
                    <button type="button" id="btvalidate" class="small-button">Validate</button>
                </div>
            </div>
            <div>
                <label for="RegAddress" class="index-label"><strong>Registered Office</strong></label>    
                <div>
                    <input type="text" id="RegAddress" name="RegAddress" placeholder="Registered Office Address" class="address-textbox" value="{{ contract['companyaddress'] if contract and contract.get('companyaddress') else '' }}">
                </div>
            </div>    
            <div>
                <label for="contactname" class="index-label"><strong>Client Contact</strong></label>    
                <div>
                    <input type="text" id="contactname" name="contactname" placeholder="Type a contact name..." autocomplete="off" class="name-textbox" value="{{ contract['contactname'] if contract and contract.get('contactname') else '' }}">
                        <div id="contactsuggestions"></div>
                </div>
            </div>
            <div>
                <label for="ContactEmail" class="index-label"><strong>Email address</strong></label>
                <div>
                    <input type="email" name="ContactEmail" placeholder="Contact email address" value="{{ contract['contactemail'] if contract and contract.get('contactemail') else '' }}">
                </div>
            </div>
            <div>
                <label for="ContactPhone" class="index-label"><strong>Phone</strong></label>
                <div>
                    <input type="tel" name="ContactPhone" placeholder="Contact phone number" value="{{ contract['contactphone'] if contract and contract.get('contactphone') else '' }}">
                </div>
            </div>
        </div>
    </div>
</form>

<script>
    $(document).ready(function() {
        // Client name suggestions
        $("#clientname").on("input", function() {
            let query = $(this).val();
            if (query.length > 0) {
                $.getJSON("/searchclients", { q: query }, function(data) {
                    let suggestions = $("#suggestions");
                    suggestions.empty();
                    data.forEach(function(item) {
                        suggestions.append(`<div>${item}</div>`);
                    });
                });
            } else {
                $("#suggestions").empty();
            }
        });

        $("#suggestions").on("click", "div", function() {
            $("#clientname").val($(this).text());
            $("#suggestions").empty();
        }); 
    });   

    // Contact name suggestions
    $("#contactname").on("input", function() {
        let query = $(this).val();
        if (query.length > 0) {
            $.getJSON("/searchcontacts", { q: query, client: $("#clientname").val()}, function(data) {
                let suggestions = $("#contactsuggestions");
                suggestions.empty();
                data.forEach(function(item) {
                    // item should be an object: {ContactName, ContactEmail, ContactPhone}
                    suggestions.append(`<div class="contact-suggestion" data-email="${item.ContactEmail || ''}" data-phone="${item.ContactPhone || ''}">${item.ContactName}</div>`);
                });
            });
        } else {
            $("#contactsuggestions").empty();
        }
    });

    
    $("#contactsuggestions").on("click", ".contact-suggestion", function() {
        $("#contactname").val($(this).text());
        $("#contactsuggestions").empty();
        // Populate phone and email fields        
        $("input[name='ContactEmail']").val($(this).data("email"));
        $("input[name='ContactPhone']").val($(this).data("phone"));
    });    
 

    // Fetch button
    $("#fetch-btn").on("click", function(e) {
            e.preventDefault();
            let clientName = $("#clientname").val();
            $.ajax({
                type: "POST",
                url: "/chfetch",
                data: { clientname: clientName },
                success: function(data) {
                    $("#RegNumber").val(data.regnumber || "");
                    $("#RegAddress").val(data.address || "");
                }
            });
        });

    // Validate button
    $("#btvalidate").on("click", function() {
        const company_number = document.getElementById('RegNumber').value;
        const company_name = document.getElementById('clientname').value;
        
        fetch('/validate_ch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `company_number=${encodeURIComponent(company_number)}&company_name=${encodeURIComponent(company_name)}`
        })
        .then(response => response.json())
        .then(data => {
            if (!data.Valid) {
                alert(data.Narrative || "Validation failed.");
            } else {
                alert("Company is valid" + (data.IsDirector ? " and director is valid." : "."));
            }
        });
    });  

</script>

{% endblock %}